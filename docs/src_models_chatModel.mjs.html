<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: src/models/chatModel.mjs</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: src/models/chatModel.mjs</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/**
 * 채팅 모델
 * 암호화와 함께 모든 채팅/AI 관련 데이터베이스 작업을 처리합니다
 * 채팅방 생성, 대화 내역 관리, 메시지 암호화/복호화 기능을 제공합니다
 * 
 * @fileoverview AI 채팅 시스템의 데이터 모델 모듈
 */
import { db } from "../config/db.mjs";
import { getNextId } from "../utils/dbUtils.mjs";
import {hashUserId, encryptData, decryptData, getTimestamp,} from "../utils/cryptoUtils.mjs";
import logger from "../utils/logger.mjs";

/**
 * 새로운 채팅방 생성
 * 사용자별로 고유한 ID를 발급하고 방 이름을 암호화하여 새 채팅방을 생성합니다
 * 데이터베이스에는 암호화된 데이터가 저장되고 응답에는 평문 데이터가 반환됩니다
 * 
 * @async
 * @function createChatRoom
 * @param {string} uid - 사용자 ID (평문)
 * @param {string} name - 채팅방 이름
 * @returns {Promise&lt;Object>} 생성된 채팅방 데이터
 * @returns {string} returns.owner - 사용자 ID (평문)
 * @returns {number} returns.id - 채팅방 ID
 * @returns {string} returns.name - 채팅방 이름 (평문)
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * const newRoom = await createChatRoom('user123', 'AI 채팅방');
 * console.log(newRoom.id); // 1, 2, 3, ...
 */
export const createChatRoom = async (uid, name) => {
  try {
    const hashedUid = hashUserId(uid);
    const roomId = await getNextId(hashedUid, "roomId");

    // 방 이름 암호화
    const encryptedName = encryptData(uid, name);

    await db("chat_rooms").insert({
      owner: hashedUid,
      id: roomId,
      name: encryptedName,
      isProcessing: 0,
      created_at: getTimestamp(),
    });

    return {
      owner: uid,
      id: roomId,
      name: name, // 응답용 평문 반환
    };
  } catch (error) {
    logger.error("채팅방 생성 오류:", error);
    throw error;
  }
};

/**
 * 복호화된 이름과 함께 사용자의 모든 채팅방 가져오기
 * 사용자의 모든 채팅방을 데이터베이스에서 조회하고 암호화된 방 이름을 복호화하여 반환합니다
 * 최신 순으로 정렬되어 반환됩니다
 * 
 * @async
 * @function getChatRooms
 * @param {string} uid - 사용자 ID (평문)
 * @returns {Promise&lt;Array&lt;Object>>} 채팅방 객체 배열
 * @returns {string} returns[].owner - 사용자 ID (평문)
 * @returns {number} returns[].id - 채팅방 ID
 * @returns {string} returns[].name - 채팅방 이름 (복호화된 평문)
 * @returns {number} returns[].isProcessing - 처리 상태
 * @returns {string} returns[].created_at - 생성 일시
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * const rooms = await getChatRooms('user123');
 * console.log(rooms[0].name); // '복호화된 채팅방 이름'
 */
export const getChatRooms = async (uid) => {
  try {
    const hashedUid = hashUserId(uid);
    const rooms = await db("chat_rooms")
      .where({ owner: hashedUid })
      .orderBy("id", "desc");

    // 방 이름 복호화
    return rooms.map((room) => ({
      ...room,
      owner: uid, // 애플리케이션 로직을 위해 원본 ID 사용
      name: decryptData(uid, room.name),
    }));
  } catch (error) {
    logger.error("채팅방 가져오기 오류:", error);
    throw error;
  }
};

/**
 * 암호화와 함께 채팅 기록에 메시지 추가
 * 사용자 메시지와 AI 응답을 암호화하여 데이터베이스에 저장합니다
 * 사용자 메시지와 AI 메시지를 순차적으로 저장하고 채팅 ID 카운터를 업데이트합니다
 * 
 * @async
 * @function addChatMessages
 * @param {string} uid - 사용자 ID (평문)
 * @param {number} roomId - 채팅방 ID
 * @param {string} userMessage - 사용자 메시지
 * @param {string} aiMessage - AI 응답 메시지
 * @returns {Promise&lt;Array&lt;Object>>} 추가된 메시지 객체 배열 (2개: 사용자 + AI)
 * @returns {number} returns[].from - 채팅방 ID
 * @returns {string} returns[].owner - 사용자 ID
 * @returns {number} returns[].id - 메시지 ID
 * @returns {string} returns[].message - 메시지 내용 (평문)
 * @returns {string} returns[].sender - 보낸이 ('user' 또는 'ai')
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * const messages = await addChatMessages('user123', 1, '안녕', '안녕하세요!');
 * console.log(messages[0].sender); // 'user'
 * console.log(messages[1].sender); // 'ai'
 */
export const addChatMessages = async (uid, roomId, userMessage, aiMessage) => {
  try {
    const hashedUid = hashUserId(uid);

    // 다음 채팅 ID 가져오기
    const chatId = await getNextId(hashedUid, "chatId");
    const timestamp = getTimestamp();

    // 메시지 암호화
    const encryptedUserMessage = encryptData(uid, userMessage);
    const encryptedAiMessage = encryptData(uid, aiMessage);

    // 사용자 메시지 추가
    await db("chat").insert({
      from: roomId,
      owner: hashedUid,
      id: chatId,
      message: encryptedUserMessage,
      sender: "user",
      created_at: timestamp,
    });

    // AI 응답 추가
    await db("chat").insert({
      from: roomId,
      owner: hashedUid,
      id: chatId + 1,
      message: encryptedAiMessage,
      sender: "ai",
      created_at: timestamp,
    });

    // 채팅 ID 카운터 업데이트
    await db("userid")
      .where({ owner: hashedUid })
      .update({ chatId: chatId + 2 });

    // 응답용 평문 메시지 반환
    return [
      {
        from: roomId,
        owner: uid,
        id: chatId,
        message: userMessage,
        sender: "user",
      },
      {
        from: roomId,
        owner: uid,
        id: chatId + 1,
        message: aiMessage,
        sender: "ai",
      },
    ];
  } catch (error) {
    logger.error("채팅 메시지 추가 오류:", error);
    throw error;
  }
};

/**
 * 복호화와 함께 방의 채팅 메시지 가져오기
 * 지정된 채팅방의 모든 메시지를 조회하고 암호화된 메시지 내용을 복호화하여 반환합니다
 * 메시지는 ID 순으로 정렬되어 시간 순서대로 반환됩니다
 * 
 * @async
 * @function getChatMessages
 * @param {string} uid - 사용자 ID (평문)
 * @param {number} roomId - 채팅방 ID
 * @returns {Promise&lt;Array&lt;Object>>} 채팅 메시지 객체 배열
 * @returns {number} returns[].from - 채팅방 ID
 * @returns {string} returns[].owner - 사용자 ID (평문)
 * @returns {number} returns[].id - 메시지 ID
 * @returns {string} returns[].message - 메시지 내용 (복호화된 평문)
 * @returns {string} returns[].sender - 보낸이 ('user' 또는 'ai')
 * @returns {string} returns[].created_at - 생성 일시
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * const messages = await getChatMessages('user123', 1);
 * messages.forEach(msg => console.log(`${msg.sender}: ${msg.message}`));
 */
export const getChatMessages = async (uid, roomId) => {
  try {
    const hashedUid = hashUserId(uid);
    const messages = await db("chat")
      .where({ owner: hashedUid, from: roomId })
      .orderBy("id", "asc");

    // 메시지 내용 복호화
    return messages.map((message) => ({
      ...message,
      owner: uid, // 애플리케이션 로직을 위해 원본 ID 사용
      message: decryptData(uid, message.message),
    }));
  } catch (error) {
    logger.error("채팅 메시지 가져오기 오류:", error);
    throw error;
  }
};

/**
 * 채팅방과 그 안의 모든 메시지 삭제
 * 지정된 채팅방이 존재하는지 확인한 후, 트랜잭션을 사용하여 안전하게 삭제합니다
 * 채팅방과 관련된 모든 메시지를 원자적으로 삭제하여 데이터 일관성을 보장합니다
 * 
 * @async
 * @function deleteChatRoom
 * @param {string} uid - 사용자 ID (평문)
 * @param {number} roomId - 삭제할 채팅방 ID
 * @returns {Promise&lt;boolean>} 삭제 성공 여부 (true: 성공)
 * @throws {Error} 채팅방을 찾을 수 없을 때 또는 데이터베이스 오류 시 예외 발생
 * @example
 * try {
 *   const deleted = await deleteChatRoom('user123', 1);
 *   console.log('채팅방 삭제 성공');
 * } catch (error) {
 *   console.error('채팅방을 찾을 수 없습니다');
 * }
 */
export const deleteChatRoom = async (uid, roomId) => {
  try {
    const hashedUid = hashUserId(uid);

    // 방이 존재하는지 확인
    const room = await db("chat_rooms")
      .where({ owner: hashedUid, id: roomId })
      .first();

    if (!room) {
      throw new Error("채팅방을 찾을 수 없습니다");
    }

    // 모든 작업이 함께 성공 또는 실패하도록 트랜잭션으로 실행
    await db.transaction(async (trx) => {
      // 방의 모든 메시지 삭제
      await trx("chat").where({ owner: hashedUid, from: roomId }).del();

      // 방 삭제
      await trx("chat_rooms").where({ owner: hashedUid, id: roomId }).del();
    });

    logger.info(
      `채팅방 삭제됨: ${hashedUid.substring(0, 8)}... - 방 ID: ${roomId}`,
    );
    return true;
  } catch (error) {
    logger.error("채팅방 삭제 오류:", error);
    throw error;
  }
};
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-apiRouter.html">apiRouter</a></li>
        <li><a href="module-auth.html">auth</a></li>
        <li><a href="module-logWithTimestamp.html">logWithTimestamp</a></li>
        <li><a href="module-sessionConfig.html">sessionConfig</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#ALLOWED_DOMAINS">ALLOWED_DOMAINS</a></li>
        <li><a href="global.html#FREE_MODELS">FREE_MODELS</a></li>
        <li><a href="global.html#PAID_MODELS">PAID_MODELS</a></li>
        <li><a href="global.html#PULL_INTERVAL">PULL_INTERVAL</a></li>
        <li><a href="global.html#SENSITIVE_FIELDS">SENSITIVE_FIELDS</a></li>
        <li><a href="global.html#SENSITIVE_HEADERS">SENSITIVE_HEADERS</a></li>
        <li><a href="global.html#addAdminField">addAdminField</a></li>
        <li><a href="global.html#addChatMessages">addChatMessages</a></li>
        <li><a href="global.html#apiRateLimiter">apiRateLimiter</a></li>
        <li><a href="global.html#app">app</a></li>
        <li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li>
        <li><a href="global.html#colors">colors</a></li>
        <li><a href="global.html#completeTask">completeTask</a></li>
        <li>
          <a href="global.html#createBodySizeLimiter">createBodySizeLimiter</a>
        </li>
        <li><a href="global.html#createChatRoom">createChatRoom</a></li>
        <li><a href="global.html#createExpressApp">createExpressApp</a></li>
        <li><a href="global.html#createHttpsServer">createHttpsServer</a></li>
        <li><a href="global.html#createPlanner">createPlanner</a></li>
        <li><a href="global.html#createRateLimiter">createRateLimiter</a></li>
        <li><a href="global.html#createTask">createTask</a></li>
        <li><a href="global.html#createUser">createUser</a></li>
        <li><a href="global.html#createWordList">createWordList</a></li>
        <li><a href="global.html#db">db</a></li>
        <li><a href="global.html#decryptData">decryptData</a></li>
        <li><a href="global.html#deleteChatRoom">deleteChatRoom</a></li>
        <li><a href="global.html#deletePlanner">deletePlanner</a></li>
        <li><a href="global.html#deleteTask">deleteTask</a></li>
        <li><a href="global.html#deleteWordList">deleteWordList</a></li>
        <li><a href="global.html#encryptData">encryptData</a></li>
        <li>
          <a href="global.html#errorLoggingMiddleware"
            >errorLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#executeGitPull">executeGitPull</a></li>
        <li><a href="global.html#executeTransaction">executeTransaction</a></li>
        <li><a href="global.html#formatDate">formatDate</a></li>
        <li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li>
        <li>
          <a href="global.html#generateAutoResponse">generateAutoResponse</a>
        </li>
        <li>
          <a href="global.html#generateCustomResponse"
            >generateCustomResponse</a
          >
        </li>
        <li>
          <a href="global.html#generateSecureToken">generateSecureToken</a>
        </li>
        <li><a href="global.html#getCSPDirectives">getCSPDirectives</a></li>
        <li><a href="global.html#getChatMessages">getChatMessages</a></li>
        <li><a href="global.html#getChatRooms">getChatRooms</a></li>
        <li><a href="global.html#getCorsConfig">getCorsConfig</a></li>
        <li><a href="global.html#getCorsOptions">getCorsOptions</a></li>
        <li>
          <a href="global.html#getCurrentMySQLDateTime"
            >getCurrentMySQLDateTime</a
          >
        </li>
        <li>
          <a href="global.html#getCustomCorsConfig">getCustomCorsConfig</a>
        </li>
        <li>
          <a href="global.html#getDevSecurityConfig">getDevSecurityConfig</a>
        </li>
        <li><a href="global.html#getEnvFilePaths">getEnvFilePaths</a></li>
        <li><a href="global.html#getEnvironmentInfo">getEnvironmentInfo</a></li>
        <li>
          <a href="global.html#getEnvironmentSecurityConfig"
            >getEnvironmentSecurityConfig</a
          >
        </li>
        <li><a href="global.html#getHashedUserId">getHashedUserId</a></li>
        <li><a href="global.html#getNextId">getNextId</a></li>
        <li><a href="global.html#getPlannerById">getPlannerById</a></li>
        <li><a href="global.html#getPlanners">getPlanners</a></li>
        <li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li>
        <li><a href="global.html#getTaskById">getTaskById</a></li>
        <li><a href="global.html#getTasks">getTasks</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getUser">getUser</a></li>
        <li><a href="global.html#getYearEndDate">getYearEndDate</a></li>
        <li><a href="global.html#getYearStartDate">getYearStartDate</a></li>
        <li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li>
        <li><a href="global.html#hashUserId">hashUserId</a></li>
        <li><a href="global.html#initializeApp">initializeApp</a></li>
        <li><a href="global.html#initializeSession">initializeSession</a></li>
        <li><a href="global.html#isAdmin">isAdmin</a></li>
        <li><a href="global.html#isEncrypted">isEncrypted</a></li>
        <li><a href="global.html#isRegistered">isRegistered</a></li>
        <li><a href="global.html#isUserExists">isUserExists</a></li>
        <li><a href="global.html#levels">levels</a></li>
        <li>
          <a href="global.html#loadEnvironmentVariables"
            >loadEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#loadSSLOptions">loadSSLOptions</a></li>
        <li><a href="global.html#logWithTimestamp">logWithTimestamp</a></li>
        <li><a href="global.html#loginRateLimiter">loginRateLimiter</a></li>
        <li><a href="global.html#maskSensitiveData">maskSensitiveData</a></li>
        <li>
          <a href="global.html#maskSensitiveHeaders">maskSensitiveHeaders</a>
        </li>
        <li><a href="global.html#openRouter">openRouter</a></li>
        <li><a href="global.html#optionalAuth">optionalAuth</a></li>
        <li><a href="global.html#options">options</a></li>
        <li>
          <a href="global.html#performanceMonitoringMiddleware"
            >performanceMonitoringMiddleware</a
          >
        </li>
        <li><a href="global.html#removeAdminUser">removeAdminUser</a></li>
        <li><a href="global.html#renamePlanner">renamePlanner</a></li>
        <li>
          <a href="global.html#requestLoggingMiddleware"
            >requestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#requireAdmin">requireAdmin</a></li>
        <li><a href="global.html#requireAuth">requireAuth</a></li>
        <li>
          <a href="global.html#responseLoggingMiddleware"
            >responseLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#safeStringify">safeStringify</a></li>
        <li><a href="global.html#securityHeaders">securityHeaders</a></li>
        <li><a href="global.html#server">server</a></li>
        <li><a href="global.html#setAdminUser">setAdminUser</a></li>
        <li>
          <a href="global.html#setDefaultEnvironmentVariables"
            >setDefaultEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#setupBodyParsing">setupBodyParsing</a></li>
        <li>
          <a href="global.html#setupCorsMiddleware">setupCorsMiddleware</a>
        </li>
        <li><a href="global.html#setupErrorHandling">setupErrorHandling</a></li>
        <li>
          <a href="global.html#setupLoggingMiddleware"
            >setupLoggingMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupProcessHandlers">setupProcessHandlers</a>
        </li>
        <li>
          <a href="global.html#setupSecurityMiddleware"
            >setupSecurityMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupTestLoggingMiddleware"
            >setupTestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#summarizeMemory">summarizeMemory</a></li>
        <li>
          <a href="global.html#testDatabaseConnection"
            >testDatabaseConnection</a
          >
        </li>
        <li><a href="global.html#updateTask">updateTask</a></li>
        <li><a href="global.html#updateUser">updateUser</a></li>
        <li><a href="global.html#validateOrigin">validateOrigin</a></li>
        <li>
          <a href="global.html#validateRequiredEnvironmentVariables"
            >validateRequiredEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#validateUserData">validateUserData</a></li>
        <li><a href="global.html#verifyUserId">verifyUserId</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Jun 12
      2025 20:26:11 GMT+0900 (대한민국 표준시)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>

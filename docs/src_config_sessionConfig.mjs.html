<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: src/config/sessionConfig.mjs</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: src/config/sessionConfig.mjs</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/**
 * 세션 구성 모듈
 * @module sessionConfig
 * @description 안전한 세션 설정 및 Redis 기반 세션 관리를 위한 유틸리티 제공
 */
import { generateSecureToken } from "../utils/cryptoUtils.mjs";
import logger from "../utils/logger.mjs";
import { RedisStore } from "connect-redis";
import { createClient } from "redis";
import { promisify } from "util";

import "./dotenv.mjs"; // 환경 변수 로드

/**
 * 세션 비밀 키 (프로덕션에서는 환경 변수로 관리)
 * @type {string}
 * @constant
 */
const SESSION_SECRET = process.env.SESSION_SECRET || generateSecureToken();

/**
 * Redis 클라이언트 인스턴스
 * @type {Object|null}
 */
let redisClient;

/**
 * Redis 기반 세션 저장소 인스턴스
 * @type {Object|null}
 */
let redisStore;

/**
 * Redis 클라이언트 초기화
 * @async
 * @function initRedisClient
 * @description Redis 서버에 연결하고 클라이언트 인스턴스를 초기화합니다
 * @returns {Promise&lt;Object>} Redis 클라이언트 객체
 * @throws {Error} Redis 연결 실패 시 에러 발생
 * @example
 * const client = await initRedisClient();
 */
export const initRedisClient = async () => {
  if (redisClient) return redisClient;

  // Redis 연결 설정
  redisClient = createClient(6379, "127.0.0.1");

  redisClient.on("error", (err) => {
    logger.error("Redis 클라이언트 오류:", err);
  });

  redisClient.on("connect", () => {
    logger.info("Redis 서버에 연결되었습니다");
  });

  redisClient.getAsync = promisify(redisClient.get).bind(redisClient);
  redisClient.setAsync = promisify(redisClient.set).bind(redisClient);
  redisClient.delAsync = promisify(redisClient.del).bind(redisClient);

  // Redis 연결
  await redisClient
    .connect()
    .catch((err) => {
      logger.error("Redis 연결 실패:", err);
      throw err;
    })
    .then(() => {
      logger.info("Redis 서버에 연결되었습니다");
      // Redis 세션 저장소 초기화
      redisStore = new RedisStore({
        client: redisClient,
        ttl: 86400, // Redis에 저장되는 세션의 TTL (초 단위)
        prefix: "dimiplan:sess:",
      });
    });

  return redisClient;
};

/**
 * Redis 기반 세션 저장소 구성
 * @async
 * @function getSessionConfig
 * @description 세션 구성 옵션을 생성하고 반환합니다
 * @returns {Promise&lt;Object>} 세션 구성 옵션 객체
 * @returns {string} returns.secret - 세션 암호화 비밀 키
 * @returns {boolean} returns.resave - 세션 재저장 여부
 * @returns {boolean} returns.saveUninitialized - 초기화되지 않은 세션 저장 여부
 * @returns {string} returns.name - 세션 쿠키 이름
 * @returns {Object} returns.store - Redis 세션 저장소
 * @returns {Object} returns.cookie - 쿠키 설정
 * @example
 * const config = await getSessionConfig();
 */
export const getSessionConfig = async () => {
  // Redis 클라이언트 초기화
  await initRedisClient().catch((err) => {
    logger.error("Redis 초기화 실패, 메모리 세션으로 폴백합니다:", err);
    // Redis 사용 불가 시 기본 메모리 세션 사용
    return null;
  });

  return {
    secret: SESSION_SECRET, // 세션 암호화 비밀 키
    resave: false, // 세션 변경되지 않아도 다시 저장하지 않음
    saveUninitialized: false, // 초기화되지 않은 세션 저장하지 않음
    name: "dimiplan.sid", // 세션 쿠키 이름
    store: redisStore, // Redis 세션 저장소
    cookie: {
      httpOnly: true, // 클라이언트 측 JavaScript 접근 방지
      secure: true, // HTTPS에서만 쿠키 전송
      sameSite: "none", // 크로스 사이트 요청 허용
      maxAge: 86400000, // 쿠키 최대 유지 시간
    },
  };
};

/**
 * 세션에 사용자 ID 저장
 * @function storeUserInSession
 * @description Passport 형식으로 세션에 사용자 ID를 저장합니다
 * @param {Object} session - 세션 객체
 * @param {string} userId - 저장할 평문 사용자 ID
 * @example
 * storeUserInSession(req.session, 'user123');
 */
export const storeUserInSession = (session, userId) => {
  // Passport 형식으로 사용자 ID 저장
  if (!session.passport) {
    session.passport = {};
  }
  session.passport.user = { id: userId };
};

/**
 * 세션에서 사용자 ID 추출
 * @function getUserFromSession
 * @description 세션에서 저장된 사용자 ID를 추출합니다
 * @param {Object} session - 세션 객체
 * @returns {string|null} 사용자 ID 또는 null
 * @example
 * const userId = getUserFromSession(req.session);
 */
export const getUserFromSession = (session) => {
  logger.verbose("세션 정보:", session);
  return session?.passport?.user?.id || null;
};

/**
 * 애플리케이션 종료 시 Redis 연결 해제
 * @async
 * @function closeRedisConnection
 * @description Redis 클라이언트 연결을 안전하게 종료합니다
 * @returns {Promise&lt;void>}
 * @example
 * await closeRedisConnection();
 */
export const closeRedisConnection = async () => {
  if (redisClient) {
    await redisClient.quit();
    logger.info("Redis 연결이 종료되었습니다");
  }
};
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-apiRouter.html">apiRouter</a></li>
        <li><a href="module-auth.html">auth</a></li>
        <li><a href="module-logWithTimestamp.html">logWithTimestamp</a></li>
        <li><a href="module-sessionConfig.html">sessionConfig</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#ALLOWED_DOMAINS">ALLOWED_DOMAINS</a></li>
        <li><a href="global.html#FREE_MODELS">FREE_MODELS</a></li>
        <li><a href="global.html#PAID_MODELS">PAID_MODELS</a></li>
        <li><a href="global.html#PULL_INTERVAL">PULL_INTERVAL</a></li>
        <li><a href="global.html#SENSITIVE_FIELDS">SENSITIVE_FIELDS</a></li>
        <li><a href="global.html#SENSITIVE_HEADERS">SENSITIVE_HEADERS</a></li>
        <li><a href="global.html#addAdminField">addAdminField</a></li>
        <li><a href="global.html#addChatMessages">addChatMessages</a></li>
        <li><a href="global.html#apiRateLimiter">apiRateLimiter</a></li>
        <li><a href="global.html#app">app</a></li>
        <li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li>
        <li><a href="global.html#colors">colors</a></li>
        <li><a href="global.html#completeTask">completeTask</a></li>
        <li>
          <a href="global.html#createBodySizeLimiter">createBodySizeLimiter</a>
        </li>
        <li><a href="global.html#createChatRoom">createChatRoom</a></li>
        <li><a href="global.html#createExpressApp">createExpressApp</a></li>
        <li><a href="global.html#createHttpsServer">createHttpsServer</a></li>
        <li><a href="global.html#createPlanner">createPlanner</a></li>
        <li><a href="global.html#createRateLimiter">createRateLimiter</a></li>
        <li><a href="global.html#createTask">createTask</a></li>
        <li><a href="global.html#createUser">createUser</a></li>
        <li><a href="global.html#createWordList">createWordList</a></li>
        <li><a href="global.html#db">db</a></li>
        <li><a href="global.html#decryptData">decryptData</a></li>
        <li><a href="global.html#deleteChatRoom">deleteChatRoom</a></li>
        <li><a href="global.html#deletePlanner">deletePlanner</a></li>
        <li><a href="global.html#deleteTask">deleteTask</a></li>
        <li><a href="global.html#deleteWordList">deleteWordList</a></li>
        <li><a href="global.html#encryptData">encryptData</a></li>
        <li>
          <a href="global.html#errorLoggingMiddleware"
            >errorLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#executeGitPull">executeGitPull</a></li>
        <li><a href="global.html#executeTransaction">executeTransaction</a></li>
        <li><a href="global.html#formatDate">formatDate</a></li>
        <li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li>
        <li>
          <a href="global.html#generateAutoResponse">generateAutoResponse</a>
        </li>
        <li>
          <a href="global.html#generateCustomResponse"
            >generateCustomResponse</a
          >
        </li>
        <li>
          <a href="global.html#generateSecureToken">generateSecureToken</a>
        </li>
        <li><a href="global.html#getCSPDirectives">getCSPDirectives</a></li>
        <li><a href="global.html#getChatMessages">getChatMessages</a></li>
        <li><a href="global.html#getChatRooms">getChatRooms</a></li>
        <li><a href="global.html#getCorsConfig">getCorsConfig</a></li>
        <li><a href="global.html#getCorsOptions">getCorsOptions</a></li>
        <li>
          <a href="global.html#getCurrentMySQLDateTime"
            >getCurrentMySQLDateTime</a
          >
        </li>
        <li>
          <a href="global.html#getCustomCorsConfig">getCustomCorsConfig</a>
        </li>
        <li>
          <a href="global.html#getDevSecurityConfig">getDevSecurityConfig</a>
        </li>
        <li><a href="global.html#getEnvFilePaths">getEnvFilePaths</a></li>
        <li><a href="global.html#getEnvironmentInfo">getEnvironmentInfo</a></li>
        <li>
          <a href="global.html#getEnvironmentSecurityConfig"
            >getEnvironmentSecurityConfig</a
          >
        </li>
        <li><a href="global.html#getHashedUserId">getHashedUserId</a></li>
        <li><a href="global.html#getNextId">getNextId</a></li>
        <li><a href="global.html#getPlannerById">getPlannerById</a></li>
        <li><a href="global.html#getPlanners">getPlanners</a></li>
        <li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li>
        <li><a href="global.html#getTaskById">getTaskById</a></li>
        <li><a href="global.html#getTasks">getTasks</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getUser">getUser</a></li>
        <li><a href="global.html#getYearEndDate">getYearEndDate</a></li>
        <li><a href="global.html#getYearStartDate">getYearStartDate</a></li>
        <li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li>
        <li><a href="global.html#hashUserId">hashUserId</a></li>
        <li><a href="global.html#initializeApp">initializeApp</a></li>
        <li><a href="global.html#initializeSession">initializeSession</a></li>
        <li><a href="global.html#isAdmin">isAdmin</a></li>
        <li><a href="global.html#isEncrypted">isEncrypted</a></li>
        <li><a href="global.html#isRegistered">isRegistered</a></li>
        <li><a href="global.html#isUserExists">isUserExists</a></li>
        <li><a href="global.html#levels">levels</a></li>
        <li>
          <a href="global.html#loadEnvironmentVariables"
            >loadEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#loadSSLOptions">loadSSLOptions</a></li>
        <li><a href="global.html#logWithTimestamp">logWithTimestamp</a></li>
        <li><a href="global.html#loginRateLimiter">loginRateLimiter</a></li>
        <li><a href="global.html#maskSensitiveData">maskSensitiveData</a></li>
        <li>
          <a href="global.html#maskSensitiveHeaders">maskSensitiveHeaders</a>
        </li>
        <li><a href="global.html#openRouter">openRouter</a></li>
        <li><a href="global.html#optionalAuth">optionalAuth</a></li>
        <li><a href="global.html#options">options</a></li>
        <li>
          <a href="global.html#performanceMonitoringMiddleware"
            >performanceMonitoringMiddleware</a
          >
        </li>
        <li><a href="global.html#removeAdminUser">removeAdminUser</a></li>
        <li><a href="global.html#renamePlanner">renamePlanner</a></li>
        <li>
          <a href="global.html#requestLoggingMiddleware"
            >requestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#requireAdmin">requireAdmin</a></li>
        <li><a href="global.html#requireAuth">requireAuth</a></li>
        <li>
          <a href="global.html#responseLoggingMiddleware"
            >responseLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#safeStringify">safeStringify</a></li>
        <li><a href="global.html#securityHeaders">securityHeaders</a></li>
        <li><a href="global.html#server">server</a></li>
        <li><a href="global.html#setAdminUser">setAdminUser</a></li>
        <li>
          <a href="global.html#setDefaultEnvironmentVariables"
            >setDefaultEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#setupBodyParsing">setupBodyParsing</a></li>
        <li>
          <a href="global.html#setupCorsMiddleware">setupCorsMiddleware</a>
        </li>
        <li><a href="global.html#setupErrorHandling">setupErrorHandling</a></li>
        <li>
          <a href="global.html#setupLoggingMiddleware"
            >setupLoggingMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupProcessHandlers">setupProcessHandlers</a>
        </li>
        <li>
          <a href="global.html#setupSecurityMiddleware"
            >setupSecurityMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupTestLoggingMiddleware"
            >setupTestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#summarizeMemory">summarizeMemory</a></li>
        <li>
          <a href="global.html#testDatabaseConnection"
            >testDatabaseConnection</a
          >
        </li>
        <li><a href="global.html#updateTask">updateTask</a></li>
        <li><a href="global.html#updateUser">updateUser</a></li>
        <li><a href="global.html#validateOrigin">validateOrigin</a></li>
        <li>
          <a href="global.html#validateRequiredEnvironmentVariables"
            >validateRequiredEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#validateUserData">validateUserData</a></li>
        <li><a href="global.html#verifyUserId">verifyUserId</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Jun 12
      2025 20:26:11 GMT+0900 (대한민국 표준시)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>

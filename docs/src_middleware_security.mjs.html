<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: src/middleware/security.mjs</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: src/middleware/security.mjs</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/**
 * 보안 미들웨어 모듈
 * 사용자 인증, 권한 검증, 요청 제한 등 보안 관련 미들웨어를 제공합니다
 * 
 * @fileoverview 보안 미들웨어 및 인증 유틸리티
 */

import rateLimit from "express-rate-limit";
import { getUserFromSession } from "../config/sessionConfig.mjs";
import { isUserExists } from "../models/userModel.mjs";
import logger from "../utils/logger.mjs";

/**
 * IP별 요청 제한 미들웨어 설정
 * DDoS 공격 및 무차별 대입 공격을 방지합니다
 * 
 * @param {Object} options - 제한 설정 옵션
 * @param {number} [options.windowMs=900000] - 시간 창 (기본: 15분)
 * @param {number} [options.max=100] - 최대 요청 수
 * @param {string} [options.message] - 제한 초과 시 메시지
 * @returns {Function} Rate limiting 미들웨어
 * @example
 * app.use('/api', createRateLimiter({ max: 1000 }));
 */
export const createRateLimiter = (options = {}) => {
  const {
    windowMs = 15 * 60 * 1000, // 15분
    max = 100, // 기본 요청 제한
    message = "요청이 너무 많습니다. 잠시 후 다시 시도해주세요.",
    standardHeaders = true,
    legacyHeaders = false,
    ...additionalOptions
  } = options;
  
  return rateLimit({
    windowMs,
    max,
    message: { error: message },
    standardHeaders,
    legacyHeaders,
    keyGenerator: (req) => {
      // IP와 User-Agent를 조합하여 더 정확한 식별
      return `${req.ip}:${req.get("User-Agent") || "unknown"}`;
    },
    handler: (req, res) => {
      logger.warn("Rate limit 초과:", {
        ip: req.ip,
        userAgent: req.get("User-Agent"),
        url: req.url,
        method: req.method
      });
      res.status(429).json({ error: message });
    },
    ...additionalOptions
  });
};

/**
 * 로그인 시도 제한 미들웨어
 * 로그인 엔드포인트에 대한 더 엄격한 제한을 적용합니다
 * 
 * @type {Function}
 */
export const loginRateLimiter = createRateLimiter({
  windowMs: 15 * 60 * 1000, // 15분
  max: 5, // 15분에 5번까지만 로그인 시도 허용
  message: "로그인 시도가 너무 많습니다. 15분 후 다시 시도해주세요.",
  skipSuccessfulRequests: true // 성공한 요청은 카운트에서 제외
});

/**
 * API 요청 제한 미들웨어
 * 일반 API 엔드포인트에 대한 표준 제한을 적용합니다
 * 
 * @type {Function}
 */
export const apiRateLimiter = createRateLimiter({
  windowMs: 15 * 60 * 1000, // 15분
  max: 1000, // 15분에 1000번까지 API 요청 허용
  message: "API 요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요."
});

/**
 * 사용자 인증 확인 미들웨어
 * 세션 기반 인증을 확인하고 사용자 정보를 req.user에 설정합니다
 * 
 * @middleware
 * @param {Object} req - Express 요청 객체
 * @param {Object} res - Express 응답 객체
 * @param {Function} next - 다음 미들웨어 함수
 * @returns {Promise&lt;void>}
 */
export const requireAuth = async (req, res, next) => {
  try {
    // 세션에서 사용자 ID 추출
    const userId = getUserFromSession(req.session);
    
    if (!userId) {
      logger.warn("인증되지 않은 접근 시도:", {
        ip: req.ip,
        url: req.url,
        userAgent: req.get("User-Agent")
      });
      return res.status(401).json({ 
        error: "인증이 필요합니다",
        code: "AUTHENTICATION_REQUIRED"
      });
    }
    
    // 사용자 존재 여부 확인
    const userExists = await isUserExists(userId);
    
    if (!userExists) {
      logger.warn("존재하지 않는 사용자 접근 시도:", {
        userId: userId.substring(0, 8) + "...", // 보안을 위해 일부만 로깅
        ip: req.ip,
        url: req.url
      });
      
      // 세션 무효화
      req.session.destroy();
      
      return res.status(401).json({ 
        error: "유효하지 않은 사용자입니다",
        code: "INVALID_USER"
      });
    }
    
    // 요청 객체에 사용자 정보 설정
    req.user = { id: userId };
    
    logger.verbose("사용자 인증 성공:", {
      userId: userId.substring(0, 8) + "...",
      url: req.url
    });
    
    next();
    
  } catch (error) {
    logger.error("인증 확인 중 오류:", error);
    res.status(500).json({ 
      error: "인증 확인 중 오류가 발생했습니다",
      code: "AUTHENTICATION_ERROR"
    });
  }
};

/**
 * 선택적 인증 미들웨어
 * 인증이 있으면 사용자 정보를 설정하지만, 없어도 통과시킵니다
 * 
 * @middleware
 * @param {Object} req - Express 요청 객체
 * @param {Object} res - Express 응답 객체
 * @param {Function} next - 다음 미들웨어 함수
 * @returns {Promise&lt;void>}
 */
export const optionalAuth = async (req, res, next) => {
  try {
    const userId = getUserFromSession(req.session);
    
    if (userId) {
      const userExists = await isUserExists(userId);
      if (userExists) {
        req.user = { id: userId };
      }
    }
    
    next();
    
  } catch (error) {
    logger.error("선택적 인증 확인 중 오류:", error);
    // 오류가 발생해도 계속 진행
    next();
  }
};

/**
 * 관리자 권한 확인 미들웨어
 * 사용자가 관리자 권한을 가지고 있는지 확인합니다
 * requireAuth 미들웨어와 함께 사용해야 합니다
 * 
 * @middleware
 * @param {Object} req - Express 요청 객체
 * @param {Object} res - Express 응답 객체
 * @param {Function} next - 다음 미들웨어 함수
 * @returns {Promise&lt;void>}
 */
export const requireAdmin = async (req, res, next) => {
  try {
    if (!req.user) {
      return res.status(401).json({ 
        error: "인증이 필요합니다",
        code: "AUTHENTICATION_REQUIRED"
      });
    }
    
    // 관리자 권한 확인 로직 (userModel에서 구현 필요)
    // const isAdmin = await checkAdminStatus(req.user.id);
    
    // 임시로 환경변수를 통한 관리자 확인 (실제로는 DB에서 확인해야 함)
    const adminUsers = process.env.ADMIN_USERS?.split(",") || [];
    const isAdmin = adminUsers.includes(req.user.id);
    
    if (!isAdmin) {
      logger.warn("관리자 권한 없는 접근 시도:", {
        userId: req.user.id.substring(0, 8) + "...",
        ip: req.ip,
        url: req.url
      });
      
      return res.status(403).json({ 
        error: "관리자 권한이 필요합니다",
        code: "ADMIN_REQUIRED"
      });
    }
    
    logger.info("관리자 권한 확인됨:", {
      userId: req.user.id.substring(0, 8) + "...",
      url: req.url
    });
    
    next();
    
  } catch (error) {
    logger.error("관리자 권한 확인 중 오류:", error);
    res.status(500).json({ 
      error: "권한 확인 중 오류가 발생했습니다",
      code: "AUTHORIZATION_ERROR"
    });
  }
};

/**
 * 요청 본문 크기 제한 미들웨어
 * 큰 요청으로 인한 메모리 소모를 방지합니다
 * 
 * @param {Object} options - 크기 제한 옵션
 * @param {string} [options.limit="1mb"] - 최대 크기
 * @returns {Function} 크기 제한 미들웨어
 */
export const createBodySizeLimiter = (options = {}) => {
  const { limit = "1mb" } = options;
  
  return (req, res, next) => {
    const contentLength = req.get("Content-Length");
    
    if (contentLength) {
      const sizeInMB = parseInt(contentLength) / (1024 * 1024);
      const limitInMB = parseFloat(limit.replace("mb", ""));
      
      if (sizeInMB > limitInMB) {
        logger.warn("요청 크기 초과:", {
          contentLength,
          limit,
          ip: req.ip,
          url: req.url
        });
        
        return res.status(413).json({ 
          error: "요청 크기가 너무 큽니다",
          code: "PAYLOAD_TOO_LARGE"
        });
      }
    }
    
    next();
  };
};

/**
 * CORS 보안 강화 미들웨어
 * 추가적인 보안 헤더를 설정합니다
 * 
 * @middleware
 * @param {Object} req - Express 요청 객체
 * @param {Object} res - Express 응답 객체
 * @param {Function} next - 다음 미들웨어 함수
 * @returns {void}
 */
export const securityHeaders = (req, res, next) => {
  // 추가 보안 헤더 설정
  res.setHeader("X-Request-ID", req.id || Math.random().toString(36).substring(7));
  res.setHeader("X-Response-Time", Date.now());
  
  // API 응답에 캐시 제어 헤더 추가
  if (req.path.startsWith("/api/")) {
    res.setHeader("Cache-Control", "no-store, no-cache, must-revalidate, private");
    res.setHeader("Pragma", "no-cache");
    res.setHeader("Expires", "0");
  }
  
  next();
};</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-apiRouter.html">apiRouter</a></li>
        <li><a href="module-auth.html">auth</a></li>
        <li><a href="module-logWithTimestamp.html">logWithTimestamp</a></li>
        <li><a href="module-sessionConfig.html">sessionConfig</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#ALLOWED_DOMAINS">ALLOWED_DOMAINS</a></li>
        <li><a href="global.html#FREE_MODELS">FREE_MODELS</a></li>
        <li><a href="global.html#PAID_MODELS">PAID_MODELS</a></li>
        <li><a href="global.html#PULL_INTERVAL">PULL_INTERVAL</a></li>
        <li><a href="global.html#SENSITIVE_FIELDS">SENSITIVE_FIELDS</a></li>
        <li><a href="global.html#SENSITIVE_HEADERS">SENSITIVE_HEADERS</a></li>
        <li><a href="global.html#addAdminField">addAdminField</a></li>
        <li><a href="global.html#addChatMessages">addChatMessages</a></li>
        <li><a href="global.html#apiRateLimiter">apiRateLimiter</a></li>
        <li><a href="global.html#app">app</a></li>
        <li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li>
        <li><a href="global.html#colors">colors</a></li>
        <li><a href="global.html#completeTask">completeTask</a></li>
        <li>
          <a href="global.html#createBodySizeLimiter">createBodySizeLimiter</a>
        </li>
        <li><a href="global.html#createChatRoom">createChatRoom</a></li>
        <li><a href="global.html#createExpressApp">createExpressApp</a></li>
        <li><a href="global.html#createHttpsServer">createHttpsServer</a></li>
        <li><a href="global.html#createPlanner">createPlanner</a></li>
        <li><a href="global.html#createRateLimiter">createRateLimiter</a></li>
        <li><a href="global.html#createTask">createTask</a></li>
        <li><a href="global.html#createUser">createUser</a></li>
        <li><a href="global.html#createWordList">createWordList</a></li>
        <li><a href="global.html#db">db</a></li>
        <li><a href="global.html#decryptData">decryptData</a></li>
        <li><a href="global.html#deleteChatRoom">deleteChatRoom</a></li>
        <li><a href="global.html#deletePlanner">deletePlanner</a></li>
        <li><a href="global.html#deleteTask">deleteTask</a></li>
        <li><a href="global.html#deleteWordList">deleteWordList</a></li>
        <li><a href="global.html#encryptData">encryptData</a></li>
        <li>
          <a href="global.html#errorLoggingMiddleware"
            >errorLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#executeGitPull">executeGitPull</a></li>
        <li><a href="global.html#executeTransaction">executeTransaction</a></li>
        <li><a href="global.html#formatDate">formatDate</a></li>
        <li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li>
        <li>
          <a href="global.html#generateAutoResponse">generateAutoResponse</a>
        </li>
        <li>
          <a href="global.html#generateCustomResponse"
            >generateCustomResponse</a
          >
        </li>
        <li>
          <a href="global.html#generateSecureToken">generateSecureToken</a>
        </li>
        <li><a href="global.html#getCSPDirectives">getCSPDirectives</a></li>
        <li><a href="global.html#getChatMessages">getChatMessages</a></li>
        <li><a href="global.html#getChatRooms">getChatRooms</a></li>
        <li><a href="global.html#getCorsConfig">getCorsConfig</a></li>
        <li><a href="global.html#getCorsOptions">getCorsOptions</a></li>
        <li>
          <a href="global.html#getCurrentMySQLDateTime"
            >getCurrentMySQLDateTime</a
          >
        </li>
        <li>
          <a href="global.html#getCustomCorsConfig">getCustomCorsConfig</a>
        </li>
        <li>
          <a href="global.html#getDevSecurityConfig">getDevSecurityConfig</a>
        </li>
        <li><a href="global.html#getEnvFilePaths">getEnvFilePaths</a></li>
        <li><a href="global.html#getEnvironmentInfo">getEnvironmentInfo</a></li>
        <li>
          <a href="global.html#getEnvironmentSecurityConfig"
            >getEnvironmentSecurityConfig</a
          >
        </li>
        <li><a href="global.html#getHashedUserId">getHashedUserId</a></li>
        <li><a href="global.html#getNextId">getNextId</a></li>
        <li><a href="global.html#getPlannerById">getPlannerById</a></li>
        <li><a href="global.html#getPlanners">getPlanners</a></li>
        <li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li>
        <li><a href="global.html#getTaskById">getTaskById</a></li>
        <li><a href="global.html#getTasks">getTasks</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getUser">getUser</a></li>
        <li><a href="global.html#getYearEndDate">getYearEndDate</a></li>
        <li><a href="global.html#getYearStartDate">getYearStartDate</a></li>
        <li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li>
        <li><a href="global.html#hashUserId">hashUserId</a></li>
        <li><a href="global.html#initializeApp">initializeApp</a></li>
        <li><a href="global.html#initializeSession">initializeSession</a></li>
        <li><a href="global.html#isAdmin">isAdmin</a></li>
        <li><a href="global.html#isEncrypted">isEncrypted</a></li>
        <li><a href="global.html#isRegistered">isRegistered</a></li>
        <li><a href="global.html#isUserExists">isUserExists</a></li>
        <li><a href="global.html#levels">levels</a></li>
        <li>
          <a href="global.html#loadEnvironmentVariables"
            >loadEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#loadSSLOptions">loadSSLOptions</a></li>
        <li><a href="global.html#logWithTimestamp">logWithTimestamp</a></li>
        <li><a href="global.html#loginRateLimiter">loginRateLimiter</a></li>
        <li><a href="global.html#maskSensitiveData">maskSensitiveData</a></li>
        <li>
          <a href="global.html#maskSensitiveHeaders">maskSensitiveHeaders</a>
        </li>
        <li><a href="global.html#openRouter">openRouter</a></li>
        <li><a href="global.html#optionalAuth">optionalAuth</a></li>
        <li><a href="global.html#options">options</a></li>
        <li>
          <a href="global.html#performanceMonitoringMiddleware"
            >performanceMonitoringMiddleware</a
          >
        </li>
        <li><a href="global.html#removeAdminUser">removeAdminUser</a></li>
        <li><a href="global.html#renamePlanner">renamePlanner</a></li>
        <li>
          <a href="global.html#requestLoggingMiddleware"
            >requestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#requireAdmin">requireAdmin</a></li>
        <li><a href="global.html#requireAuth">requireAuth</a></li>
        <li>
          <a href="global.html#responseLoggingMiddleware"
            >responseLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#safeStringify">safeStringify</a></li>
        <li><a href="global.html#securityHeaders">securityHeaders</a></li>
        <li><a href="global.html#server">server</a></li>
        <li><a href="global.html#setAdminUser">setAdminUser</a></li>
        <li>
          <a href="global.html#setDefaultEnvironmentVariables"
            >setDefaultEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#setupBodyParsing">setupBodyParsing</a></li>
        <li>
          <a href="global.html#setupCorsMiddleware">setupCorsMiddleware</a>
        </li>
        <li><a href="global.html#setupErrorHandling">setupErrorHandling</a></li>
        <li>
          <a href="global.html#setupLoggingMiddleware"
            >setupLoggingMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupProcessHandlers">setupProcessHandlers</a>
        </li>
        <li>
          <a href="global.html#setupSecurityMiddleware"
            >setupSecurityMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupTestLoggingMiddleware"
            >setupTestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#summarizeMemory">summarizeMemory</a></li>
        <li>
          <a href="global.html#testDatabaseConnection"
            >testDatabaseConnection</a
          >
        </li>
        <li><a href="global.html#updateTask">updateTask</a></li>
        <li><a href="global.html#updateUser">updateUser</a></li>
        <li><a href="global.html#validateOrigin">validateOrigin</a></li>
        <li>
          <a href="global.html#validateRequiredEnvironmentVariables"
            >validateRequiredEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#validateUserData">validateUserData</a></li>
        <li><a href="global.html#verifyUserId">verifyUserId</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Jun 12
      2025 20:36:08 GMT+0900 (대한민국 표준시)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: src/utils/dbUtils.mjs</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: src/utils/dbUtils.mjs</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/**
 * 데이터베이스 유틸리티 함수
 * 오류 처리 및 트랜잭션 관리를 위한 공통 데이터베이스 작업을 제공합니다
 * 안전한 트랜잭션 실행, 사용자별 ID 관리, 데이터베이스 연결 테스트 기능을 포함합니다
 * 
 * @fileoverview 데이터베이스 작업을 위한 공통 유틸리티 모듈
 */
import db from "../config/db.mjs";
import logger from "./logger.mjs";

/**
 * 안전한 데이터베이스 트랜잭션 실행
 * 데이터베이스 작업 중 오류 발생 시 자동으로 롤백을 수행하고 오류를 로그에 기록합니다
 * 복잡한 데이터베이스 작업에서 데이터 일관성을 보장합니다
 * 
 * @async
 * @function executeTransaction
 * @param {Function} transactionFn - 트랜잭션 작업을 포함하는 비동기 함수
 * @param {Object} transactionFn.trx - Knex 트랜잭션 객체
 * @returns {Promise&lt;*>} 트랜잭션 실행 결과
 * @throws {Error} 트랜잭션 실패 시 예외 발생
 * @example
 * // 복수 테이블 업데이트
 * const result = await executeTransaction(async (trx) => {
 *   await trx('users').where('id', userId).update({ name: newName });
 *   await trx('logs').insert({ action: 'update_user', userId });
 *   return 'success';
 * });
 */
export const executeTransaction = async (transactionFn) => {
  try {
    return await db.transaction(transactionFn);
  } catch (error) {
    logger.error("데이터베이스 트랜잭션 오류:", error);
    throw error;
  }
};

/**
 * 사용자별 다음 사용 가능한 ID 조회 및 업데이트
 * 사용자별로 고유한 ID 카운터를 관리하여 충돌 없는 ID를 생성합니다
 * 사용자가 처음 접근하는 경우 userid 테이블을 초기화하고, 기존 사용자는 현재 값을 증가시킵니다
 * 
 * @async
 * @function getNextId
 * @param {string} uid - 사용자 ID (해시된 사용자 ID)
 * @param {string} idType - ID 유형 (plannerId, planId, roomId, chatId 중 하나)
 * @returns {Promise&lt;number>} 다음 사용 가능한 ID 번호
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * // 새 플래너 ID 발급
 * const newPlannerId = await getNextId(hashedUserId, 'plannerId');
 * console.log(newPlannerId); // 1, 2, 3, ...
 * 
 * // 새 채팅방 ID 발급
 * const newRoomId = await getNextId(hashedUserId, 'roomId');
 * console.log(newRoomId); // 사용자별 순차적 ID
 */
export const getNextId = async (uid, idType) => {
  try {
    // 사용자의 userid 테이블 존재 여부 확인
    const userData = await db("userid")
      .where({ owner: uid })
      .select(idType)
      .first();

    if (!userData) {
      // 사용자 ID 초기화
      await db("userid").insert({
        owner: uid,
        plannerId: 1,
        planId: 1,
        roomId: 1,
        chatId: 1,
      });

      logger.info(`새 사용자 ID 초기화 - 사용자: ${uid}`);
      return 1;
    }

    const currentId = userData[idType];

    // 다음 ID로 업데이트
    await db("userid")
      .where({ owner: uid })
      .update({ [idType]: currentId + 1 });

    logger.verbose(`다음 ${idType} ID 발급 - 사용자: ${uid}, ID: ${currentId}`);
    return currentId;
  } catch (error) {
    logger.error(`다음 ${idType} ID 조회 중 오류 - 사용자: ${uid}`, error);
    throw error;
  }
};

/**
 * 데이터베이스 연결 테스트
 * 데이터베이스 연결 상태를 확인하고 진단 정보를 로그에 기록합니다
 * 간단한 SELECT 1 쿼리를 실행하여 연결 상태를 검증합니다
 * 애플리케이션 시작 시나 헬스 체크에 유용합니다
 * 
 * @async
 * @function testDatabaseConnection
 * @returns {Promise&lt;boolean>} 데이터베이스 연결 상태 (true: 연결 성공, false: 연결 실패)
 * @example
 * // 애플리케이션 시작 시 연결 테스트
 * const isConnected = await testDatabaseConnection();
 * if (!isConnected) {
 *   console.error('데이터베이스 연결 실패');
 *   process.exit(1);
 * }
 * 
 * // 헬스 체크 엔드포인트
 * app.get('/health', async (req, res) => {
 *   const dbStatus = await testDatabaseConnection();
 *   res.json({ database: dbStatus });
 * });
 */
export const testDatabaseConnection = async () => {
  try {
    await db.raw("SELECT 1");
    logger.info("데이터베이스 연결 성공");
    return true;
  } catch (error) {
    logger.error("데이터베이스 연결 실패:", error);
    return false;
  }
};
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-apiRouter.html">apiRouter</a></li>
        <li><a href="module-auth.html">auth</a></li>
        <li><a href="module-logWithTimestamp.html">logWithTimestamp</a></li>
        <li><a href="module-sessionConfig.html">sessionConfig</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#ALLOWED_DOMAINS">ALLOWED_DOMAINS</a></li>
        <li><a href="global.html#FREE_MODELS">FREE_MODELS</a></li>
        <li><a href="global.html#PAID_MODELS">PAID_MODELS</a></li>
        <li><a href="global.html#PULL_INTERVAL">PULL_INTERVAL</a></li>
        <li><a href="global.html#SENSITIVE_FIELDS">SENSITIVE_FIELDS</a></li>
        <li><a href="global.html#SENSITIVE_HEADERS">SENSITIVE_HEADERS</a></li>
        <li><a href="global.html#addAdminField">addAdminField</a></li>
        <li><a href="global.html#addChatMessages">addChatMessages</a></li>
        <li><a href="global.html#apiRateLimiter">apiRateLimiter</a></li>
        <li><a href="global.html#app">app</a></li>
        <li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li>
        <li><a href="global.html#colors">colors</a></li>
        <li><a href="global.html#completeTask">completeTask</a></li>
        <li>
          <a href="global.html#createBodySizeLimiter">createBodySizeLimiter</a>
        </li>
        <li><a href="global.html#createChatRoom">createChatRoom</a></li>
        <li><a href="global.html#createExpressApp">createExpressApp</a></li>
        <li><a href="global.html#createHttpsServer">createHttpsServer</a></li>
        <li><a href="global.html#createPlanner">createPlanner</a></li>
        <li><a href="global.html#createRateLimiter">createRateLimiter</a></li>
        <li><a href="global.html#createTask">createTask</a></li>
        <li><a href="global.html#createUser">createUser</a></li>
        <li><a href="global.html#createWordList">createWordList</a></li>
        <li><a href="global.html#db">db</a></li>
        <li><a href="global.html#decryptData">decryptData</a></li>
        <li><a href="global.html#deleteChatRoom">deleteChatRoom</a></li>
        <li><a href="global.html#deletePlanner">deletePlanner</a></li>
        <li><a href="global.html#deleteTask">deleteTask</a></li>
        <li><a href="global.html#deleteWordList">deleteWordList</a></li>
        <li><a href="global.html#encryptData">encryptData</a></li>
        <li>
          <a href="global.html#errorLoggingMiddleware"
            >errorLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#executeGitPull">executeGitPull</a></li>
        <li><a href="global.html#executeTransaction">executeTransaction</a></li>
        <li><a href="global.html#formatDate">formatDate</a></li>
        <li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li>
        <li>
          <a href="global.html#generateAutoResponse">generateAutoResponse</a>
        </li>
        <li>
          <a href="global.html#generateCustomResponse"
            >generateCustomResponse</a
          >
        </li>
        <li>
          <a href="global.html#generateSecureToken">generateSecureToken</a>
        </li>
        <li><a href="global.html#getCSPDirectives">getCSPDirectives</a></li>
        <li><a href="global.html#getChatMessages">getChatMessages</a></li>
        <li><a href="global.html#getChatRooms">getChatRooms</a></li>
        <li><a href="global.html#getCorsConfig">getCorsConfig</a></li>
        <li><a href="global.html#getCorsOptions">getCorsOptions</a></li>
        <li>
          <a href="global.html#getCurrentMySQLDateTime"
            >getCurrentMySQLDateTime</a
          >
        </li>
        <li>
          <a href="global.html#getCustomCorsConfig">getCustomCorsConfig</a>
        </li>
        <li>
          <a href="global.html#getDevSecurityConfig">getDevSecurityConfig</a>
        </li>
        <li><a href="global.html#getEnvFilePaths">getEnvFilePaths</a></li>
        <li><a href="global.html#getEnvironmentInfo">getEnvironmentInfo</a></li>
        <li>
          <a href="global.html#getEnvironmentSecurityConfig"
            >getEnvironmentSecurityConfig</a
          >
        </li>
        <li><a href="global.html#getHashedUserId">getHashedUserId</a></li>
        <li><a href="global.html#getNextId">getNextId</a></li>
        <li><a href="global.html#getPlannerById">getPlannerById</a></li>
        <li><a href="global.html#getPlanners">getPlanners</a></li>
        <li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li>
        <li><a href="global.html#getTaskById">getTaskById</a></li>
        <li><a href="global.html#getTasks">getTasks</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getUser">getUser</a></li>
        <li><a href="global.html#getYearEndDate">getYearEndDate</a></li>
        <li><a href="global.html#getYearStartDate">getYearStartDate</a></li>
        <li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li>
        <li><a href="global.html#hashUserId">hashUserId</a></li>
        <li><a href="global.html#initializeApp">initializeApp</a></li>
        <li><a href="global.html#initializeSession">initializeSession</a></li>
        <li><a href="global.html#isAdmin">isAdmin</a></li>
        <li><a href="global.html#isEncrypted">isEncrypted</a></li>
        <li><a href="global.html#isRegistered">isRegistered</a></li>
        <li><a href="global.html#isUserExists">isUserExists</a></li>
        <li><a href="global.html#levels">levels</a></li>
        <li>
          <a href="global.html#loadEnvironmentVariables"
            >loadEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#loadSSLOptions">loadSSLOptions</a></li>
        <li><a href="global.html#logWithTimestamp">logWithTimestamp</a></li>
        <li><a href="global.html#loginRateLimiter">loginRateLimiter</a></li>
        <li><a href="global.html#maskSensitiveData">maskSensitiveData</a></li>
        <li>
          <a href="global.html#maskSensitiveHeaders">maskSensitiveHeaders</a>
        </li>
        <li><a href="global.html#openRouter">openRouter</a></li>
        <li><a href="global.html#optionalAuth">optionalAuth</a></li>
        <li><a href="global.html#options">options</a></li>
        <li>
          <a href="global.html#performanceMonitoringMiddleware"
            >performanceMonitoringMiddleware</a
          >
        </li>
        <li><a href="global.html#removeAdminUser">removeAdminUser</a></li>
        <li><a href="global.html#renamePlanner">renamePlanner</a></li>
        <li>
          <a href="global.html#requestLoggingMiddleware"
            >requestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#requireAdmin">requireAdmin</a></li>
        <li><a href="global.html#requireAuth">requireAuth</a></li>
        <li>
          <a href="global.html#responseLoggingMiddleware"
            >responseLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#safeStringify">safeStringify</a></li>
        <li><a href="global.html#securityHeaders">securityHeaders</a></li>
        <li><a href="global.html#server">server</a></li>
        <li><a href="global.html#setAdminUser">setAdminUser</a></li>
        <li>
          <a href="global.html#setDefaultEnvironmentVariables"
            >setDefaultEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#setupBodyParsing">setupBodyParsing</a></li>
        <li>
          <a href="global.html#setupCorsMiddleware">setupCorsMiddleware</a>
        </li>
        <li><a href="global.html#setupErrorHandling">setupErrorHandling</a></li>
        <li>
          <a href="global.html#setupLoggingMiddleware"
            >setupLoggingMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupProcessHandlers">setupProcessHandlers</a>
        </li>
        <li>
          <a href="global.html#setupSecurityMiddleware"
            >setupSecurityMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupTestLoggingMiddleware"
            >setupTestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#summarizeMemory">summarizeMemory</a></li>
        <li>
          <a href="global.html#testDatabaseConnection"
            >testDatabaseConnection</a
          >
        </li>
        <li><a href="global.html#updateTask">updateTask</a></li>
        <li><a href="global.html#updateUser">updateUser</a></li>
        <li><a href="global.html#validateOrigin">validateOrigin</a></li>
        <li>
          <a href="global.html#validateRequiredEnvironmentVariables"
            >validateRequiredEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#validateUserData">validateUserData</a></li>
        <li><a href="global.html#verifyUserId">verifyUserId</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Jun 12
      2025 20:36:08 GMT+0900 (대한민국 표준시)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: src/utils/logger.mjs</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: src/utils/logger.mjs</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/**
 * 로깅 유틸리티
 * 민감한 데이터 필터링과 구조화된 로깅 기능 제공
 * 
 * @fileoverview Winston 기반 로깅 시스템 및 보안 필터링
 */
import winston, { addColors, createLogger } from "winston";
const { format, transports } = winston;
import { existsSync, mkdirSync } from "fs";
import { join } from "path";
import "../config/dotenv.mjs"; // 환경 변수 로드

/**
 * 로그 레벨 정의
 * Winston 로거에서 사용할 로그 레벨들을 정의합니다
 * 
 * @type {Object}
 * @property {number} error - 치명적인 오류 (0)
 * @property {number} warn - 경고성 메시지 (1)
 * @property {number} info - 일반 정보 (2)
 * @property {number} verbose - 상세 로깅, 테스트 환경용 (3)
 */
const levels = {
  error: 0,
  warn: 1,
  info: 2,
  verbose: 3
};

/**
 * 각 로그 레벨별 콘솔 색상 정의
 * 콘솔 출력 시 가독성을 높이기 위한 색상 설정
 * 
 * @type {Object}
 */
const colors = {
  error: "red",
  warn: "yellow",
  info: "green",
  verbose: "cyan"
};

addColors(colors);

/**
 * 안전한 JSON 직렬화 함수
 * 순환 참조 및 복잡한 객체 처리를 위한 안전한 직렬화
 * 
 * @param {any} obj - 직렬화할 객체
 * @returns {string} 직렬화된 JSON 문자열
 * @example
 * const result = safeStringify({ circular: obj });
 */
const safeStringify = (obj) => {
  if (!obj) return String(obj);

  // 원시 타입 처리
  if (typeof obj !== "object") return String(obj);

  // 순환 참조 방지를 위한 캐시
  const cache = new Set();

  // 순환 참조 및 복잡한 객체 처리를 위한 대체자 함수
  const replacer = (key, value) => {
    if (typeof value === "object" &amp;&amp; value !== null) {
      if (cache.has(value)) {
        return "[순환 참조]";
      }
      cache.add(value);

      // 오류 객체 특별 처리
      if (value instanceof Error) {
        return {
          name: value.name,
          message: value.message,
          stack: value.stack,
        };
      }

      // 복잡한 시스템 객체 필터링
      if (
        value.constructor &amp;&amp;
        ["Socket", "IncomingMessage", "ServerResponse", "HTTPParser"].includes(
          value.constructor.name,
        )
      ) {
        return `[${value.constructor.name}]`;
      }
    }
    return value;
  };

  try {
    return JSON.stringify(obj, replacer);
  } catch (error) {
    return `[직렬화 불가 객체: ${error.message}]`;
  }
};

// 로그 디렉토리 정의
const logDir = join(process.cwd(), "logs");

// 로그 디렉토리 생성
try {
  if (!existsSync(logDir)) {
    mkdirSync(logDir, { recursive: true, mode: 0o755 });
  }
} catch (err) {
  console.error(`로그 디렉토리 생성 실패: ${err.message}`);
}

// 테스트 환경 확인
const isTestEnvironment = process.env.NODE_ENV === "test";

// 로그 레벨 설정
const logLevel = isTestEnvironment
  ? "verbose"
  : process.env.LOG_LEVEL || "info";

// 로거 생성
export const logger = createLogger({
  level: logLevel,
  levels,
  format: format.combine(
    format.timestamp({ format: "YYYY-MM-DD HH:mm:ss" }),
    format.printf((info) => {
      const { timestamp, level, message, ...rest } = info;
      const restString = Object.keys(rest).length
        ? ` ${safeStringify(rest)}`
        : "";
      return `${timestamp} ${level}: ${message}${restString}`;
    }),
  ),
  transports: [
    new transports.Console({
      format: format.combine(
        format.colorize({ all: true }),
        format.printf((info) => {
          const { timestamp, level, message, ...rest } = info;
          const restString = Object.keys(rest).length
            ? ` ${safeStringify(rest)}`
            : "";
          return `${timestamp} ${level}: ${message}${restString}`;
        }),
      ),
    }),
    new transports.File({
      filename: join(logDir, "combined.log"),
      maxsize: 5242880, // 5MB
      maxFiles: 5,
    }),
    new transports.File({
      filename: join(logDir, "errors.log"),
      level: "error",
      maxsize: 5242880, // 5MB
      maxFiles: 5,
    }),
  ],
  exitOnError: false,
});

// 외부 노출 로깅 함수
export default {
  error: (message, meta = {}) => logger.error(message, meta),
  warn: (message, meta = {}) => logger.warn(message, meta),
  info: (message, meta = {}) => logger.info(message, meta),
  verbose: (message, meta = {}) => logger.verbose(message, meta),

  // 테스트 환경용 추가 로깅 함수
  logRequest: (req) => {
    if (isTestEnvironment) {
      logger.verbose(`요청: ${req.method} ${req.url}`, {
        headers: req.headers,
        body: req.body,
        query: req.query,
        ip: req.ip,
      });
    }
  },
  logResponse: (req, res, body) => {
    if (isTestEnvironment) {
      logger.verbose(`응답: ${req.method} ${req.url} [${res.statusCode}]`, {
        headers: res.getHeaders(),
        body: body,
      });
    }
  },
  logDbQuery: (query, bindings) => {
    if (isTestEnvironment) {
      logger.verbose(`DB QUERY`, {
        sql: query,
        bindings: bindings,
      });
    }
  },
  // 기타 유틸리티
  isTestEnvironment,
  stream: {
    write: (message) => logger.verbose(message.trim()),
  },
};
</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-apiRouter.html">apiRouter</a></li>
        <li><a href="module-auth.html">auth</a></li>
        <li><a href="module-logWithTimestamp.html">logWithTimestamp</a></li>
        <li><a href="module-sessionConfig.html">sessionConfig</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#ALLOWED_DOMAINS">ALLOWED_DOMAINS</a></li>
        <li><a href="global.html#FREE_MODELS">FREE_MODELS</a></li>
        <li><a href="global.html#PAID_MODELS">PAID_MODELS</a></li>
        <li><a href="global.html#PULL_INTERVAL">PULL_INTERVAL</a></li>
        <li><a href="global.html#SENSITIVE_FIELDS">SENSITIVE_FIELDS</a></li>
        <li><a href="global.html#SENSITIVE_HEADERS">SENSITIVE_HEADERS</a></li>
        <li><a href="global.html#addAdminField">addAdminField</a></li>
        <li><a href="global.html#addChatMessages">addChatMessages</a></li>
        <li><a href="global.html#apiRateLimiter">apiRateLimiter</a></li>
        <li><a href="global.html#app">app</a></li>
        <li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li>
        <li><a href="global.html#colors">colors</a></li>
        <li><a href="global.html#completeTask">completeTask</a></li>
        <li>
          <a href="global.html#createBodySizeLimiter">createBodySizeLimiter</a>
        </li>
        <li><a href="global.html#createChatRoom">createChatRoom</a></li>
        <li><a href="global.html#createExpressApp">createExpressApp</a></li>
        <li><a href="global.html#createHttpsServer">createHttpsServer</a></li>
        <li><a href="global.html#createPlanner">createPlanner</a></li>
        <li><a href="global.html#createRateLimiter">createRateLimiter</a></li>
        <li><a href="global.html#createTask">createTask</a></li>
        <li><a href="global.html#createUser">createUser</a></li>
        <li><a href="global.html#createWordList">createWordList</a></li>
        <li><a href="global.html#db">db</a></li>
        <li><a href="global.html#decryptData">decryptData</a></li>
        <li><a href="global.html#deleteChatRoom">deleteChatRoom</a></li>
        <li><a href="global.html#deletePlanner">deletePlanner</a></li>
        <li><a href="global.html#deleteTask">deleteTask</a></li>
        <li><a href="global.html#deleteWordList">deleteWordList</a></li>
        <li><a href="global.html#encryptData">encryptData</a></li>
        <li>
          <a href="global.html#errorLoggingMiddleware"
            >errorLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#executeGitPull">executeGitPull</a></li>
        <li><a href="global.html#executeTransaction">executeTransaction</a></li>
        <li><a href="global.html#formatDate">formatDate</a></li>
        <li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li>
        <li>
          <a href="global.html#generateAutoResponse">generateAutoResponse</a>
        </li>
        <li>
          <a href="global.html#generateCustomResponse"
            >generateCustomResponse</a
          >
        </li>
        <li>
          <a href="global.html#generateSecureToken">generateSecureToken</a>
        </li>
        <li><a href="global.html#getCSPDirectives">getCSPDirectives</a></li>
        <li><a href="global.html#getChatMessages">getChatMessages</a></li>
        <li><a href="global.html#getChatRooms">getChatRooms</a></li>
        <li><a href="global.html#getCorsConfig">getCorsConfig</a></li>
        <li><a href="global.html#getCorsOptions">getCorsOptions</a></li>
        <li>
          <a href="global.html#getCurrentMySQLDateTime"
            >getCurrentMySQLDateTime</a
          >
        </li>
        <li>
          <a href="global.html#getCustomCorsConfig">getCustomCorsConfig</a>
        </li>
        <li>
          <a href="global.html#getDevSecurityConfig">getDevSecurityConfig</a>
        </li>
        <li><a href="global.html#getEnvFilePaths">getEnvFilePaths</a></li>
        <li><a href="global.html#getEnvironmentInfo">getEnvironmentInfo</a></li>
        <li>
          <a href="global.html#getEnvironmentSecurityConfig"
            >getEnvironmentSecurityConfig</a
          >
        </li>
        <li><a href="global.html#getHashedUserId">getHashedUserId</a></li>
        <li><a href="global.html#getNextId">getNextId</a></li>
        <li><a href="global.html#getPlannerById">getPlannerById</a></li>
        <li><a href="global.html#getPlanners">getPlanners</a></li>
        <li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li>
        <li><a href="global.html#getTaskById">getTaskById</a></li>
        <li><a href="global.html#getTasks">getTasks</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getUser">getUser</a></li>
        <li><a href="global.html#getYearEndDate">getYearEndDate</a></li>
        <li><a href="global.html#getYearStartDate">getYearStartDate</a></li>
        <li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li>
        <li><a href="global.html#hashUserId">hashUserId</a></li>
        <li><a href="global.html#initializeApp">initializeApp</a></li>
        <li><a href="global.html#initializeSession">initializeSession</a></li>
        <li><a href="global.html#isAdmin">isAdmin</a></li>
        <li><a href="global.html#isEncrypted">isEncrypted</a></li>
        <li><a href="global.html#isRegistered">isRegistered</a></li>
        <li><a href="global.html#isUserExists">isUserExists</a></li>
        <li><a href="global.html#levels">levels</a></li>
        <li>
          <a href="global.html#loadEnvironmentVariables"
            >loadEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#loadSSLOptions">loadSSLOptions</a></li>
        <li><a href="global.html#logWithTimestamp">logWithTimestamp</a></li>
        <li><a href="global.html#loginRateLimiter">loginRateLimiter</a></li>
        <li><a href="global.html#maskSensitiveData">maskSensitiveData</a></li>
        <li>
          <a href="global.html#maskSensitiveHeaders">maskSensitiveHeaders</a>
        </li>
        <li><a href="global.html#openRouter">openRouter</a></li>
        <li><a href="global.html#optionalAuth">optionalAuth</a></li>
        <li><a href="global.html#options">options</a></li>
        <li>
          <a href="global.html#performanceMonitoringMiddleware"
            >performanceMonitoringMiddleware</a
          >
        </li>
        <li><a href="global.html#removeAdminUser">removeAdminUser</a></li>
        <li><a href="global.html#renamePlanner">renamePlanner</a></li>
        <li>
          <a href="global.html#requestLoggingMiddleware"
            >requestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#requireAdmin">requireAdmin</a></li>
        <li><a href="global.html#requireAuth">requireAuth</a></li>
        <li>
          <a href="global.html#responseLoggingMiddleware"
            >responseLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#safeStringify">safeStringify</a></li>
        <li><a href="global.html#securityHeaders">securityHeaders</a></li>
        <li><a href="global.html#server">server</a></li>
        <li><a href="global.html#setAdminUser">setAdminUser</a></li>
        <li>
          <a href="global.html#setDefaultEnvironmentVariables"
            >setDefaultEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#setupBodyParsing">setupBodyParsing</a></li>
        <li>
          <a href="global.html#setupCorsMiddleware">setupCorsMiddleware</a>
        </li>
        <li><a href="global.html#setupErrorHandling">setupErrorHandling</a></li>
        <li>
          <a href="global.html#setupLoggingMiddleware"
            >setupLoggingMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupProcessHandlers">setupProcessHandlers</a>
        </li>
        <li>
          <a href="global.html#setupSecurityMiddleware"
            >setupSecurityMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupTestLoggingMiddleware"
            >setupTestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#summarizeMemory">summarizeMemory</a></li>
        <li>
          <a href="global.html#testDatabaseConnection"
            >testDatabaseConnection</a
          >
        </li>
        <li><a href="global.html#updateTask">updateTask</a></li>
        <li><a href="global.html#updateUser">updateUser</a></li>
        <li><a href="global.html#validateOrigin">validateOrigin</a></li>
        <li>
          <a href="global.html#validateRequiredEnvironmentVariables"
            >validateRequiredEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#validateUserData">validateUserData</a></li>
        <li><a href="global.html#verifyUserId">verifyUserId</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Jun 12
      2025 20:36:08 GMT+0900 (대한민국 표준시)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>

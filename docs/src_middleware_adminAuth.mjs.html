<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>JSDoc: Source: src/middleware/adminAuth.mjs</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link
      type="text/css"
      rel="stylesheet"
      href="styles/prettify-tomorrow.css"
    />
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css" />
  </head>

  <body>
    <div id="main">
      <h1 class="page-title">Source: src/middleware/adminAuth.mjs</h1>

      <section>
        <article>
          <pre class="prettyprint source linenums"><code>/**
 * 관리자 인증 미들웨어
 * 관리자 권한이 있는 사용자만 특정 라우트에 접근할 수 있도록 제한
 */
import { getUser } from "../models/userModel.mjs";
import { db } from "../config/db.mjs";
import { hashUserId } from "../utils/cryptoUtils.mjs";
import logger from "../utils/logger.mjs";

/**
 * 관리자 권한 검증 미들웨어
 * 사용자가 로그인되어 있고 isAdmin이 1인지 확인합니다
 * 
 * @param {Object} req - Express 요청 객체
 * @param {string} req.user.id - 사용자 ID
 * @param {string} req.ip - 클라이언트 IP 주소
 * @param {Object} res - Express 응답 객체
 * @param {Function} next - 다음 미들웨어 함수
 * @returns {Promise&lt;void>} 권한 검증 결과에 따라 next() 호출 또는 응답 반환
 * @example
 * // 라우터에서 사용
 * router.get('/admin', isAdmin, (req, res) => {
 *   res.json({ message: '관리자 페이지' });
 * });
 */
export const isAdmin = async (req, res, next) => {
  try {
    // 사용자가 로그인되어 있는지 확인
    if (!req.user || !req.user.id) {
      logger.warn("관리자 페이지 접근 시도 - 인증되지 않은 사용자", { 
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });
      return res.status(401).json({ 
        success: false, 
        message: "인증이 필요합니다" 
      });
    }

    // 사용자의 관리자 권한 확인
    const hashedUid = hashUserId(req.user.id);
    const adminCheck = await db("users")
      .where("id", hashedUid)
      .select("isAdmin")
      .first();

    if (!adminCheck || adminCheck.isAdmin !== 1) {
      logger.warn("관리자 페이지 접근 시도 - 권한 없음", { 
        userId: req.user.id,
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });
      return res.status(403).json({ 
        success: false, 
        message: "관리자 권한이 필요합니다" 
      });
    }

    // 관리자 권한 확인됨
    logger.info("관리자 페이지 접근", { 
      adminId: req.user.id,
      ip: req.ip
    });
    
    next();
  } catch (error) {
    logger.error("관리자 권한 검증 중 오류:", error);
    res.status(500).json({ 
      success: false, 
      message: "권한 검증 중 오류가 발생했습니다" 
    });
  }
};

/**
 * 특정 사용자를 관리자로 설정
 * 사용자 ID로 해당 사용자의 isAdmin 필드를 1로 설정합니다
 * 
 * @param {string} userId - 사용자 ID
 * @returns {Promise&lt;boolean>} 성공 여부
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * // 사용자를 관리자로 설정
 * const success = await setAdminUser('user123');
 * console.log(success); // true or false
 */
export const setAdminUser = async (userId) => {
  try {
    const hashedUid = hashUserId(userId);
    const result = await db("users")
      .where("id", hashedUid)
      .update({ 
        isAdmin: 1,
        updated_at: new Date()
      });

    if (result > 0) {
      logger.info("사용자를 관리자로 설정함", { userId });
      return true;
    } else {
      logger.warn("사용자를 찾을 수 없어 관리자로 설정할 수 없음", { userId });
      return false;
    }
  } catch (error) {
    logger.error("관리자 설정 중 오류:", error);
    throw error;
  }
};

/**
 * 사용자의 관리자 권한 제거
 * 사용자 ID로 해당 사용자의 isAdmin 필드를 0으로 설정합니다
 * 
 * @param {string} userId - 사용자 ID
 * @returns {Promise&lt;boolean>} 성공 여부
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * // 사용자의 관리자 권한 제거
 * const success = await removeAdminUser('user123');
 * console.log(success); // true or false
 */
export const removeAdminUser = async (userId) => {
  try {
    const hashedUid = hashUserId(userId);
    const result = await db("users")
      .where("id", hashedUid)
      .update({ 
        isAdmin: 0,
        updated_at: new Date()
      });

    if (result > 0) {
      logger.info("사용자의 관리자 권한 제거함", { userId });
      return true;
    } else {
      logger.warn("사용자를 찾을 수 없어 관리자 권한을 제거할 수 없음", { userId });
      return false;
    }
  } catch (error) {
    logger.error("관리자 권한 제거 중 오류:", error);
    throw error;
  }
};

/**
 * 사용자의 관리자 권한 확인
 * 사용자 ID로 해당 사용자가 관리자인지 확인합니다
 * 
 * @param {string} userId - 사용자 ID
 * @returns {Promise&lt;boolean>} 관리자 여부 (true: 관리자, false: 일반 사용자)
 * @throws {Error} 데이터베이스 오류 시 예외 발생
 * @example
 * // 사용자의 관리자 권한 확인
 * const isAdminUser = await checkAdminStatus('user123');
 * console.log(isAdminUser); // true or false
 */
export const checkAdminStatus = async (userId) => {
  try {
    const hashedUid = hashUserId(userId);
    const adminCheck = await db("users")
      .where("id", hashedUid)
      .select("isAdmin")
      .first();

    return adminCheck &amp;&amp; adminCheck.isAdmin === 1;
  } catch (error) {
    logger.error("관리자 상태 확인 중 오류:", error);
    throw error;
  }
};</code></pre>
        </article>
      </section>
    </div>

    <nav>
      <h2><a href="index.html">Home</a></h2>
      <h3>Modules</h3>
      <ul>
        <li><a href="module-apiRouter.html">apiRouter</a></li>
        <li><a href="module-auth.html">auth</a></li>
        <li><a href="module-logWithTimestamp.html">logWithTimestamp</a></li>
        <li><a href="module-sessionConfig.html">sessionConfig</a></li>
      </ul>
      <h3>Global</h3>
      <ul>
        <li><a href="global.html#ALLOWED_DOMAINS">ALLOWED_DOMAINS</a></li>
        <li><a href="global.html#FREE_MODELS">FREE_MODELS</a></li>
        <li><a href="global.html#PAID_MODELS">PAID_MODELS</a></li>
        <li><a href="global.html#PULL_INTERVAL">PULL_INTERVAL</a></li>
        <li><a href="global.html#SENSITIVE_FIELDS">SENSITIVE_FIELDS</a></li>
        <li><a href="global.html#SENSITIVE_HEADERS">SENSITIVE_HEADERS</a></li>
        <li><a href="global.html#addAdminField">addAdminField</a></li>
        <li><a href="global.html#addChatMessages">addChatMessages</a></li>
        <li><a href="global.html#apiRateLimiter">apiRateLimiter</a></li>
        <li><a href="global.html#app">app</a></li>
        <li><a href="global.html#checkAdminStatus">checkAdminStatus</a></li>
        <li><a href="global.html#colors">colors</a></li>
        <li><a href="global.html#completeTask">completeTask</a></li>
        <li>
          <a href="global.html#createBodySizeLimiter">createBodySizeLimiter</a>
        </li>
        <li><a href="global.html#createChatRoom">createChatRoom</a></li>
        <li><a href="global.html#createExpressApp">createExpressApp</a></li>
        <li><a href="global.html#createHttpsServer">createHttpsServer</a></li>
        <li><a href="global.html#createPlanner">createPlanner</a></li>
        <li><a href="global.html#createRateLimiter">createRateLimiter</a></li>
        <li><a href="global.html#createTask">createTask</a></li>
        <li><a href="global.html#createUser">createUser</a></li>
        <li><a href="global.html#createWordList">createWordList</a></li>
        <li><a href="global.html#db">db</a></li>
        <li><a href="global.html#decryptData">decryptData</a></li>
        <li><a href="global.html#deleteChatRoom">deleteChatRoom</a></li>
        <li><a href="global.html#deletePlanner">deletePlanner</a></li>
        <li><a href="global.html#deleteTask">deleteTask</a></li>
        <li><a href="global.html#deleteWordList">deleteWordList</a></li>
        <li><a href="global.html#encryptData">encryptData</a></li>
        <li>
          <a href="global.html#errorLoggingMiddleware"
            >errorLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#executeGitPull">executeGitPull</a></li>
        <li><a href="global.html#executeTransaction">executeTransaction</a></li>
        <li><a href="global.html#formatDate">formatDate</a></li>
        <li><a href="global.html#formatDateForMySQL">formatDateForMySQL</a></li>
        <li>
          <a href="global.html#generateAutoResponse">generateAutoResponse</a>
        </li>
        <li>
          <a href="global.html#generateCustomResponse"
            >generateCustomResponse</a
          >
        </li>
        <li>
          <a href="global.html#generateSecureToken">generateSecureToken</a>
        </li>
        <li><a href="global.html#getCSPDirectives">getCSPDirectives</a></li>
        <li><a href="global.html#getChatMessages">getChatMessages</a></li>
        <li><a href="global.html#getChatRooms">getChatRooms</a></li>
        <li><a href="global.html#getCorsConfig">getCorsConfig</a></li>
        <li><a href="global.html#getCorsOptions">getCorsOptions</a></li>
        <li>
          <a href="global.html#getCurrentMySQLDateTime"
            >getCurrentMySQLDateTime</a
          >
        </li>
        <li>
          <a href="global.html#getCustomCorsConfig">getCustomCorsConfig</a>
        </li>
        <li>
          <a href="global.html#getDevSecurityConfig">getDevSecurityConfig</a>
        </li>
        <li><a href="global.html#getEnvFilePaths">getEnvFilePaths</a></li>
        <li><a href="global.html#getEnvironmentInfo">getEnvironmentInfo</a></li>
        <li>
          <a href="global.html#getEnvironmentSecurityConfig"
            >getEnvironmentSecurityConfig</a
          >
        </li>
        <li><a href="global.html#getHashedUserId">getHashedUserId</a></li>
        <li><a href="global.html#getNextId">getNextId</a></li>
        <li><a href="global.html#getPlannerById">getPlannerById</a></li>
        <li><a href="global.html#getPlanners">getPlanners</a></li>
        <li><a href="global.html#getSecurityConfig">getSecurityConfig</a></li>
        <li><a href="global.html#getTaskById">getTaskById</a></li>
        <li><a href="global.html#getTasks">getTasks</a></li>
        <li><a href="global.html#getTimestamp">getTimestamp</a></li>
        <li><a href="global.html#getUser">getUser</a></li>
        <li><a href="global.html#getYearEndDate">getYearEndDate</a></li>
        <li><a href="global.html#getYearStartDate">getYearStartDate</a></li>
        <li><a href="global.html#gracefulShutdown">gracefulShutdown</a></li>
        <li><a href="global.html#hashUserId">hashUserId</a></li>
        <li><a href="global.html#initializeApp">initializeApp</a></li>
        <li><a href="global.html#initializeSession">initializeSession</a></li>
        <li><a href="global.html#isAdmin">isAdmin</a></li>
        <li><a href="global.html#isEncrypted">isEncrypted</a></li>
        <li><a href="global.html#isRegistered">isRegistered</a></li>
        <li><a href="global.html#isUserExists">isUserExists</a></li>
        <li><a href="global.html#levels">levels</a></li>
        <li>
          <a href="global.html#loadEnvironmentVariables"
            >loadEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#loadSSLOptions">loadSSLOptions</a></li>
        <li><a href="global.html#logWithTimestamp">logWithTimestamp</a></li>
        <li><a href="global.html#loginRateLimiter">loginRateLimiter</a></li>
        <li><a href="global.html#maskSensitiveData">maskSensitiveData</a></li>
        <li>
          <a href="global.html#maskSensitiveHeaders">maskSensitiveHeaders</a>
        </li>
        <li><a href="global.html#openRouter">openRouter</a></li>
        <li><a href="global.html#optionalAuth">optionalAuth</a></li>
        <li><a href="global.html#options">options</a></li>
        <li>
          <a href="global.html#performanceMonitoringMiddleware"
            >performanceMonitoringMiddleware</a
          >
        </li>
        <li><a href="global.html#removeAdminUser">removeAdminUser</a></li>
        <li><a href="global.html#renamePlanner">renamePlanner</a></li>
        <li>
          <a href="global.html#requestLoggingMiddleware"
            >requestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#requireAdmin">requireAdmin</a></li>
        <li><a href="global.html#requireAuth">requireAuth</a></li>
        <li>
          <a href="global.html#responseLoggingMiddleware"
            >responseLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#safeStringify">safeStringify</a></li>
        <li><a href="global.html#securityHeaders">securityHeaders</a></li>
        <li><a href="global.html#server">server</a></li>
        <li><a href="global.html#setAdminUser">setAdminUser</a></li>
        <li>
          <a href="global.html#setDefaultEnvironmentVariables"
            >setDefaultEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#setupBodyParsing">setupBodyParsing</a></li>
        <li>
          <a href="global.html#setupCorsMiddleware">setupCorsMiddleware</a>
        </li>
        <li><a href="global.html#setupErrorHandling">setupErrorHandling</a></li>
        <li>
          <a href="global.html#setupLoggingMiddleware"
            >setupLoggingMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupProcessHandlers">setupProcessHandlers</a>
        </li>
        <li>
          <a href="global.html#setupSecurityMiddleware"
            >setupSecurityMiddleware</a
          >
        </li>
        <li>
          <a href="global.html#setupTestLoggingMiddleware"
            >setupTestLoggingMiddleware</a
          >
        </li>
        <li><a href="global.html#summarizeMemory">summarizeMemory</a></li>
        <li>
          <a href="global.html#testDatabaseConnection"
            >testDatabaseConnection</a
          >
        </li>
        <li><a href="global.html#updateTask">updateTask</a></li>
        <li><a href="global.html#updateUser">updateUser</a></li>
        <li><a href="global.html#validateOrigin">validateOrigin</a></li>
        <li>
          <a href="global.html#validateRequiredEnvironmentVariables"
            >validateRequiredEnvironmentVariables</a
          >
        </li>
        <li><a href="global.html#validateUserData">validateUserData</a></li>
        <li><a href="global.html#verifyUserId">verifyUserId</a></li>
      </ul>
    </nav>

    <br class="clear" />

    <footer>
      Documentation generated by
      <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Jun 12
      2025 20:36:08 GMT+0900 (대한민국 표준시)
    </footer>

    <script>
      prettyPrint();
    </script>
    <script src="scripts/linenumber.js"></script>
  </body>
</html>
